# Требования: Портирование MLSAC на Folia с поддержкой обратной совместимости

## Введение

MLSAC - это современный античит для Minecraft серверов, построенный на основе анализа поведения игроков. Текущая версия использует Paper API 1.16.5 и работает на Spigot/Paper серверах. Требуется портировать плагин на Folia - новую архитектуру Minecraft серверов с поддержкой многопоточности и региональной обработки, **сохраняя при этом совместимость с обычными Spigot/Paper серверами**. Плагин должен автоматически определять тип сервера и использовать соответствующую реализацию.

## Глоссарий

- **Folia**: Форк Paper с поддержкой многопоточной обработки регионов
- **Scheduler**: Система планирования задач в Bukkit/Spigot
- **Region**: Регион в Folia, обрабатываемый отдельным потоком
- **Tick**: Один цикл обновления сервера (50ms на 20 TPS)
- **Listener**: Обработчик событий Bukkit
- **Entity**: Сущность в игре (игрок, моб и т.д.)
- **Location**: Координаты в мире
- **Async Task**: Асинхронная задача, выполняемая вне основного потока
- **Scheduler Abstraction**: Абстрактный слой для работы с планировщиком задач, поддерживающий как Bukkit, так и Folia
- **Server Type Detection**: Механизм определения типа сервера (Folia или обычный Bukkit/Paper/Spigot)
- **Dual Compatibility**: Поддержка работы плагина на обоих типах серверов

## Требования

### Требование 1: Определение типа сервера и инициализация

**User Story:** Как разработчик, я хочу, чтобы плагин автоматически определял тип сервера (Folia или обычный), чтобы использовать соответствующую реализацию.

#### Acceptance Criteria

1. WHEN плагин загружается, THE система SHALL определить, является ли сервер Folia или обычным Bukkit/Paper/Spigot
2. WHEN тип сервера определён, THE система SHALL инициализировать соответствующий Scheduler Adapter
3. WHEN плагин работает на Folia, THE система SHALL использовать Folia Scheduler API
4. WHEN плагин работает на обычном сервере, THE система SHALL использовать Bukkit Scheduler API
5. WHEN определение типа сервера не удаётся, THE система SHALL выбросить исключение с понятным сообщением об ошибке

### Требование 2: Абстрактный слой планирования задач

**User Story:** Как разработчик, я хочу иметь единый интерфейс для планирования задач, который работает на обоих типах серверов.

#### Acceptance Criteria

1. THE система SHALL предоставить интерфейс SchedulerAdapter с методами для планирования задач
2. WHEN задача должна быть выполнена синхронно, THE SchedulerAdapter SHALL использовать соответствующий метод для текущего типа сервера
3. WHEN задача должна быть выполнена асинхронно, THE SchedulerAdapter SHALL использовать соответствующий метод для текущего типа сервера
4. WHEN задача связана с сущностью, THE SchedulerAdapter SHALL использовать Entity Scheduler на Folia и обычный Scheduler на других серверах
5. WHEN задача связана с регионом, THE SchedulerAdapter SHALL использовать Region Scheduler на Folia и обычный Scheduler на других серверах

### Требование 3: Обновление зависимостей для поддержки обоих типов серверов

**User Story:** Как разработчик, я хочу обновить зависимости проекта, чтобы поддерживать как Folia, так и обычные серверы.

#### Acceptance Criteria

1. WHEN проект собирается, THE build.gradle SHALL содержать зависимость на Folia API
2. WHEN проект собирается, THE build.gradle SHALL содержать зависимость на Paper API для обратной совместимости
3. WHEN проект собирается, THE Java версия SHALL быть 17 или выше
4. WHEN плагин загружается, THE plugin.yml SHALL указывать поддержку обоих типов серверов

### Требование 4: Миграция системы планирования задач

**User Story:** Как разработчик, я хочу обновить систему планирования задач, чтобы она работала с обоими типами серверов.

#### Acceptance Criteria

1. WHEN задача должна быть выполнена на основном потоке, THE система SHALL использовать SchedulerAdapter для выбора правильного метода
2. WHEN задача связана с конкретной сущностью, THE система SHALL использовать Entity Scheduler на Folia или обычный Scheduler на других серверах
3. WHEN задача асинхронна, THE система SHALL использовать Global Async Scheduler на Folia или обычный Async Scheduler на других серверах
4. WHEN планируется повторяющаяся задача, THE система SHALL использовать соответствующие методы SchedulerAdapter

### Требование 5: Обновление обработчиков событий

**User Story:** Как разработчик, я хочу обновить обработчики событий, чтобы они корректно работали с обоими типами серверов.

#### Acceptance Criteria

1. WHEN событие срабатывает, THE обработчик SHALL быть потокобезопасным на обоих типах серверов
2. WHEN обработчик обращается к данным сущности, THE обработчик SHALL использовать SchedulerAdapter для синхронизации
3. WHEN обработчик обращается к данным мира, THE обработчик SHALL использовать SchedulerAdapter для синхронизации
4. WHEN обработчик выполняет асинхронные операции, THE обработчик SHALL корректно обрабатывать результаты в правильном потоке

### Требование 6: Обновление работы с сущностями и локациями

**User Story:** Как разработчик, я хочу обновить код работы с сущностями и локациями, чтобы избежать race conditions на обоих типах серверов.

#### Acceptance Criteria

1. WHEN код обращается к позиции сущности, THE обращение SHALL быть синхронизировано через SchedulerAdapter
2. WHEN код изменяет состояние сущности, THE изменение SHALL быть выполнено в правильном потоке (Entity Scheduler на Folia, основной поток на других серверах)
3. WHEN код работает с несколькими сущностями, THE операции SHALL быть правильно синхронизированы
4. WHEN код получает Location, THE Location SHALL быть безопасно использована в контексте обоих типов серверов

### Требование 7: Обновление системы сбора данных

**User Story:** Как разработчик, я хочу обновить систему сбора данных о игроках, чтобы она работала на обоих типах серверов.

#### Acceptance Criteria

1. WHEN данные игрока собираются, THE сбор данных SHALL быть потокобезопасным на обоих типах серверов
2. WHEN данные сохраняются, THE операция сохранения SHALL быть синхронизирована через SchedulerAdapter
3. WHEN данные читаются, THE чтение SHALL быть синхронизировано с записью
4. WHEN сессия игрока завершается, THE данные SHALL быть корректно очищены

### Требование 8: Обновление системы проверок (Checks)

**User Story:** Как разработчик, я хочу обновить систему проверок античита, чтобы она корректно работала на обоих типах серверов.

#### Acceptance Criteria

1. WHEN проверка выполняется, THE проверка SHALL быть потокобезопасной на обоих типах серверов
2. WHEN проверка обращается к данным игрока, THE обращение SHALL быть синхронизировано через SchedulerAdapter
3. WHEN проверка обращается к данным мира, THE обращение SHALL быть синхронизировано через SchedulerAdapter
4. WHEN результат проверки готов, THE результат SHALL быть обработан в правильном потоке

### Требование 9: Обновление системы штрафов и действий

**User Story:** Как разработчик, я хочу обновить систему выполнения штрафов, чтобы она корректно работала на обоих типах серверов.

#### Acceptance Criteria

1. WHEN штраф должен быть выполнен, THE выполнение SHALL быть синхронизировано через SchedulerAdapter
2. WHEN выполняется команда (kick, ban), THE команда SHALL быть выполнена в правильном потоке
3. WHEN отправляется алерт, THE алерт SHALL быть отправлен безопасно на обоих типах серверов
4. WHEN обновляется счётчик нарушений, THE обновление SHALL быть потокобезопасным

### Требование 10: Обновление системы конфигурации

**User Story:** Как администратор, я хочу, чтобы конфигурация плагина была совместима с обоими типами серверов.

#### Acceptance Criteria

1. WHEN плагин загружается, THE конфигурация SHALL быть корректно загружена на обоих типах серверов
2. WHEN конфигурация перезагружается, THE новые параметры SHALL быть применены безопасно
3. WHEN конфигурация содержит параметры, специфичные для Folia, THE параметры SHALL быть корректно обработаны или проигнорированы на других серверах

### Требование 11: Тестирование совместимости

**User Story:** Как разработчик, я хочу убедиться, что плагин работает корректно на обоих типах серверов.

#### Acceptance Criteria

1. WHEN плагин запускается на Folia сервере, THE плагин SHALL загружаться без ошибок
2. WHEN плагин запускается на обычном сервере, THE плагин SHALL загружаться без ошибок
3. WHEN плагин работает, THE нет race conditions и deadlocks на обоих типах серверов
4. WHEN плагин работает, THE производительность не деградирует на обоих типах серверов
5. WHEN плагин работает, THE все функции работают корректно на обоих типах серверов

